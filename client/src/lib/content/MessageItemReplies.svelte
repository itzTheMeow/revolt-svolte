<script lang="ts">
	import { MessageDetails, UserColor } from "$lib/utils";
	import { IconCornerLeftDown } from "@tabler/icons-svelte";
	import type { BaseMessage, Message } from "revkit";
	import { writable } from "svelte/store";
	import { floatingMenu, showMemberContext } from "../contextmenu/FloatingMenu";
	import Markdown from "../markdown/Markdown.svelte";
	import { ModalStack } from "../modals/ModalStack";

	export let message: Message;

	const fetching = new Set<string>();

	let replies = writable<(BaseMessage | string)[]>([]);
	$: replies.set(
		message.replyIDs?.map((id, i) => {
			const msg = message.channel?.messages.get(id);
			if (msg) return msg;
			else {
				if (!fetching.has(id)) {
					fetching.add(id);
					message.channel?.fetchMessage(id).then((msg) => {
						$replies[i] = msg || id;
						fetching.delete(id);
					});
				}
				return id;
			}
		}) || [],
	);
</script>

<div class="mt-3 -mb-2.5 pl-1.5">
	{#each $replies
		.filter((reply, i) => {
			return $replies.findIndex((r) => (typeof r == "string" ? r : r.id) == (typeof reply == "string" ? reply : reply.id)) >= i;
		})
		.sort((r1, r2) => (typeof r1 == "string" ? 0 : r1.createdAt) - (typeof r2 == "string" ? 0 : r2.createdAt)) as reply (typeof reply == "string" ? reply : reply.id)}
		{#if typeof reply == "string"}
			<div class="flex gap-2 items-center">
				<IconCornerLeftDown size={18} />
				<div class="flex gap-2 items-center text-[14px]">
					<img
						class="w-4 h-4 rounded-full -ml-1"
						src="https://api.revolt.chat/users/{reply}/default_avatar"
						alt=""
					/>
				</div>
				<div
					class="flex-1 overflow-hidden overflow-ellipsis whitespace-nowrap cursor-pointer"
					data-clickable
				>
					<i>Unknown Message</i>
				</div>
			</div>
		{:else if reply?.isUser()}
			<div class="flex gap-2 items-center">
				<IconCornerLeftDown size={18} />
				<div
					class="cursor-pointer flex gap-2 items-center text-[14px] hover:[--u:underline]"
					data-clickable
					on:click={(e) => {
						if (typeof reply == "string" || !reply.isUser()) return;
						if (reply.member) showMemberContext(reply.member, e.clientX, e.clientY, e.target);
						else ModalStack.push({ type: "user", id: reply.authorID });
						e.preventDefault();
						e.stopPropagation();
						return false;
					}}
					on:dblclick={(e) => {
						if ($floatingMenu) floatingMenu.set(null);
						ModalStack.push({ type: "user", id: message.authorID });
						e.preventDefault();
						e.stopPropagation();
						return false;
					}}
				>
					<img
						class="w-4 h-4 rounded-full -ml-1"
						src={reply
							? MessageDetails(reply).avatar
							: `https://api.revolt.chat/users/${
									message.replyIDs?.[$replies.indexOf(reply)]
							  }/default_avatar`}
						alt=""
					/>
					<div
						class="[text-decoration-line:var(--u)]"
						style={UserColor(MessageDetails(reply).color || "inherit")}
					>
						{message.mentionIDs.includes(reply.authorID) ? "@" : ""}{reply
							? MessageDetails(reply).name
							: "Unknown User"}
					</div>
				</div>
				<div
					class="flex-1 overflow-hidden overflow-ellipsis whitespace-nowrap cursor-pointer"
					data-clickable
				>
					{#if !reply}
						...
					{:else if reply.content}
						<Markdown text={reply.content} line noPointer />
					{:else}
						<i>Sent an Attachment</i>
					{/if}
				</div>
			</div>
		{/if}
	{/each}
</div>
